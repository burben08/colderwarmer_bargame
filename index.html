<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zurich Bar Hunt</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100vh; overflow: hidden; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; display: flex; flex-direction: column; background: #f5f5f5; }
        .hidden { display: none !important; }

        /* --- Setup Screen --- */
        #setupScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }
        .setup-card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 600px; width: 100%; }
        .setup-card h1 { font-size: 28px; text-align: center; margin-bottom: 30px; color: #333; }
        .setup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .setup-group { display: flex; flex-direction: column; }
        .setup-group label { margin-bottom: 8px; font-weight: 500; color: #555; }
        .setup-group input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; outline-color: #667eea; }
        #startGameBtn {
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        #startGameBtn:hover { background: #5a6edc; }
        #setupError { color: #e53e3e; text-align: center; margin-top: 15px; min-height: 20px; }

        /* --- Game Screen --- */
        #gameScreen { height: 100%; display: flex; flex-direction: column; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; position: relative; }
        .header h1 { font-size: 24px; margin-bottom: 15px; }
        .game-info { display: flex; gap: 20px; margin-bottom: 15px; font-size: 14px; }
        .game-info span { background: rgba(255, 255, 255, 0.2); padding: 8px 12px; border-radius: 6px; }
        .search-container { display: flex; gap: 10px; max-width: 600px; align-items: center; }
        .search-input { flex: 1; padding: 12px 16px; border: none; border-radius: 8px; font-size: 16px; outline: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .search-input:disabled { background: #f0f0f0; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-primary { background: white; color: #667eea; }
        .btn-confirm { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        #resetBtn { position: absolute; top: 20px; right: 20px; background: none; border: none; cursor: pointer; }
        #resetBtn svg { width: 32px; height: 32px; fill: white; transition: transform 0.3s; }
        #resetBtn:hover svg { transform: rotate(180deg); }
        .message { margin-top: 10px; padding: 10px 16px; border-radius: 6px; font-size: 14px; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .message.success { background: rgba(255, 255, 255, 0.2); color: white; }
        .message.error { background: rgba(255, 255, 255, 0.2); color: #ffe0e0; }
        .message.win { background: #4CAF50; color: white; font-weight: 600; font-size: 16px; }
        .message.warmer { background: rgba(255, 100, 50, 0.3); color: white; font-weight: 600; }
        .message.colder { background: rgba(100, 150, 255, 0.3); color: white; font-weight: 600; }
        #map { flex: 1; width: 100%; }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .leaflet-popup-content { margin: 12px; font-size: 14px; }
        .bar-popup h3 { margin: 0 0 8px 0; color: #667eea; font-size: 16px; }
        .bar-popup p { margin: 4px 0; color: #666; }
        .visit-number { display: inline-block; background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; text-align: center; line-height: 24px; font-weight: 600; font-size: 12px; }
    </style>
</head>
<body>

    <div id="setupScreen">
        <div class="setup-card">
            <h1>üç∫ New Bar Hunt</h1>
            <div class="setup-group">
                <label for="startLocationInput">Starting Location</label>
                <input type="text" id="startLocationInput" value="Paradeplatz">
            </div>
            <div class="setup-grid" style="margin-top: 20px;">
                <div class="setup-group">
                    <label for="northBoundInput">North Boundary</label>
                    <input type="number" step="0.001" id="northBoundInput" value="47.39">
                </div>
                <div class="setup-group">
                    <label for="southBoundInput">South Boundary</label>
                    <input type="number" step="0.001" id="southBoundInput" value="47.365">
                </div>
                <div class="setup-group">
                    <label for="eastBoundInput">East Boundary</label>
                    <input type="number" step="0.001" id="eastBoundInput" value="8.56">
                </div>
                <div class="setup-group">
                    <label for="westBoundInput">West Boundary</label>
                    <input type="number" step="0.001" id="westBoundInput" value="8.52">
                </div>
            </div>
            <div id="setupError"></div>
            <button id="startGameBtn">Start Game</button>
        </div>
    </div>

    <div id="gameScreen" class="hidden">
        <div class="header">
            <button id="resetBtn" title="New Game">
                <svg viewBox="0 0 24 24"><path d="M17.65,6.35C16.2,4.9,14.21,4,12,4A8,8,0,0,0,4,12A8,8,0,0,0,12,20C15.73,20,18.84,17.45,19.73,14H17.65C16.83,16.33,14.61,18,12,18A6,6,0,0,1,6,12A6,6,0,0,1,12,6C13.55,6,14.93,6.6,15.96,7.65L13,10.61H20V3.61L17.65,6.35Z"></path></svg>
            </button>
            <h1>üç∫ Zurich Bar Hunt Game</h1>
            <div class="game-info">
                <span>üéØ Target: <strong id="targetBar">???</strong></span>
                <span>üìç Visits: <strong id="visitCount">0</strong></span>
                <span>üìç Starting Point: <strong id="startingBar">Paradeplatz</strong></span>
            </div>
            <div class="search-container">
                <input type="text" id="barInput" class="search-input" placeholder="Enter a bar name..." autocomplete="off"/>
                <button id="previewBtn" class="btn btn-primary">Preview</button>
                <button id="confirmBtn" class="btn btn-confirm hidden">Confirm Guess</button>
                <button id="cancelBtn" class="btn btn-cancel hidden">Cancel</button>
            </div>
            <div id="message"></div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // --- DOM ELEMENTS ---
        const setupScreen = document.getElementById('setupScreen');
        const gameScreen = document.getElementById('gameScreen');
        const startGameBtn = document.getElementById('startGameBtn');
        const barInput = document.getElementById('barInput');
        const previewBtn = document.getElementById('previewBtn');
        const confirmBtn = document.getElementById('confirmBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const resetBtn = document.getElementById('resetBtn');

        // --- GAME STATE & VARS ---
        let GAME_BOUNDS = { south: 47.365, north: 47.39, west: 8.52, east: 8.56 };
        let gameState = {
            targetBar: null, targetLocation: null, visitedBars: [],
            visitCount: 0, gameWon: false,
            startingPoint: { name: 'Paradeplatz', lat: 47.3697, lng: 8.5392 }
        };
        let previewedLocation = null;
        const zurichBars = ['Kronenhalle', 'Mars Bar', 'Gleis', 'Rio Bar'];
        let map = null;
        let gameArea = null;
        let markers = [];
        let pathLine = null;
        let eliminationZones = [];
        let previewLine = null;

        // --- ICONS ---
        const visitedIcon = (number, isWarmer) => L.divIcon({ html: `<div style="background: ${isWarmer ? '#FF6347' : '#4169E1'}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 600; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${number}</div>`, className: '', iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16] });
        const winIcon = L.divIcon({ html: '<div style="background: #4CAF50; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; border: 3px solid white; box-shadow: 0 2px 12px rgba(0,0,0,0.4); animation: pulse 1s infinite;">üéâ</div><style>@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); }}</style>', className: '', iconSize: [40, 40], iconAnchor: [20, 20], popupAnchor: [0, -20] });
        const startIcon = L.divIcon({ html: '<div style="background: #FFA500; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üèÅ</div>', className: '', iconSize: [32, 32], iconAnchor: [16, 16], popupAnchor: [0, -16] });
        
        // --- ALGORITHMS ---
        function getBisectorLinePoints(p1_xy, p2_xy) {
            const rect = { x: GAME_BOUNDS.west, y: GAME_BOUNDS.south, width: GAME_BOUNDS.east - GAME_BOUNDS.west, height: GAME_BOUNDS.north - GAME_BOUNDS.south };
            const dx = p2_xy.x - p1_xy.x;
            const dy = p2_xy.y - p1_xy.y;
            if (Math.abs(dx) < 1e-9 && Math.abs(dy) < 1e-9) return [];
            const midPoint = { x: (p1_xy.x + p2_xy.x) / 2, y: (p1_xy.y + p2_xy.y) / 2 };
            const a = dx; const b = dy; const c = -dx * midPoint.x - dy * midPoint.y;
            const intersections = [];
            if (Math.abs(b) > 1e-9) { const x = (-c - b * (rect.y + rect.height)) / a; if (x >= rect.x && x <= rect.x + rect.width) intersections.push({ y: rect.y + rect.height, x: x }); }
            if (Math.abs(b) > 1e-9) { const x = (-c - b * rect.y) / a; if (x >= rect.x && x <= rect.x + rect.width) intersections.push({ y: rect.y, x: x }); }
            if (Math.abs(a) > 1e-9) { const y = (-c - a * rect.x) / b; if (y >= rect.y && y <= rect.y + rect.height) intersections.push({ y: y, x: rect.x }); }
            if (Math.abs(a) > 1e-9) { const y = (-c - a * (rect.x + rect.width)) / b; if (y >= rect.y && y <= rect.y + rect.height) intersections.push({ y: y, x: rect.x + rect.width }); }
            const uniquePoints = []; const seen = new Set();
            for (const p of intersections) { const key = `${p.x.toFixed(7)},${p.y.toFixed(7)}`; if (!seen.has(key)) { uniquePoints.push(p); seen.add(key); } }
            return uniquePoints.length >= 2 ? [ [uniquePoints[0].y, uniquePoints[0].x], [uniquePoints[1].y, uniquePoints[1].x] ] : [];
        }
        function getRectangleSlice(rect, pointA, pointB) {
            const dx = pointB.x - pointA.x; const dy = pointB.y - pointA.y;
            if (Math.abs(dx) < 1e-9 && Math.abs(dy) < 1e-9) { return [ { x: rect.x, y: rect.y }, { x: rect.x + rect.width, y: rect.y }, { x: rect.x + rect.width, y: rect.y + rect.height }, { x: rect.x, y: rect.y + rect.height }]; }
            const midPoint = { x: (pointA.x + pointB.x) / 2, y: (pointA.y + pointB.y) / 2 };
            const line = { a: dx, b: dy, c: -dx * midPoint.x - dy * midPoint.y };
            const sideOfA = line.a * pointA.x + line.b * pointA.y + line.c;
            const isInside = (p) => (line.a * p.x + line.b * p.y + line.c) * sideOfA >= 0;
            const subjectPolygon = [ { x: rect.x, y: rect.y }, { x: rect.x + rect.width, y: rect.y }, { x: rect.x + rect.width, y: rect.y + rect.height }, { x: rect.x, y: rect.y + rect.height } ];
            const outputPolygon = []; let S = subjectPolygon[subjectPolygon.length - 1];
            for (const E of subjectPolygon) {
                const sIsInside = isInside(S); const eIsInside = isInside(E);
                if (eIsInside) { if (!sIsInside) outputPolygon.push(getIntersection(S, E, line)); outputPolygon.push(E); } else if (sIsInside) { outputPolygon.push(getIntersection(S, E, line)); }
                S = E;
            } return outputPolygon;
        }
        function getIntersection(p1, p2, line) {
            const { a, b, c } = line; const dx = p2.x - p1.x; const dy = p2.y - p1.y;
            const denominator = a * dx + b * dy; if (Math.abs(denominator) < 1e-9) return p1;
            const t = -(a * p1.x + b * p1.y + c) / denominator; return { x: p1.x + t * dx, y: p1.y + t * dy };
        }
        function createEliminationZone(prevBar, currentBar, isWarmer) {
            const rect = { x: GAME_BOUNDS.west, y: GAME_BOUNDS.south, width: GAME_BOUNDS.east - GAME_BOUNDS.west, height: GAME_BOUNDS.north - GAME_BOUNDS.south };
            const pointToEliminate = isWarmer ? prevBar : currentBar; const pointToKeep = isWarmer ? currentBar : prevBar;
            const pointA_xy = { x: pointToEliminate.lng, y: pointToEliminate.lat }; const pointB_xy = { x: pointToKeep.lng, y: pointToKeep.lat };
            const polygonVertices = getRectangleSlice(rect, pointA_xy, pointB_xy); if (polygonVertices.length < 3) return null;
            const leafletCoords = polygonVertices.map(p => [p.y, p.x]);
            const zone = L.polygon(leafletCoords, { color: '#dc2626', weight: 1, fillColor: '#ef4444', fillOpacity: 0.2 }).addTo(map);
            eliminationZones.push(zone);
        }

        // --- GAME LOGIC ---
        function distance(p1, p2) { return Math.sqrt(Math.pow(p1.lat - p2.lat, 2) + Math.pow(p1.lng - p2.lng, 2)); }
        async function geocodeLocation(query) {
            const url = `https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&lon=8.5417&lat=47.3769&limit=1`;
            const response = await fetch(url); if (!response.ok) throw new Error('Network error');
            const data = await response.json(); if (!data.features || data.features.length === 0) throw new Error(`'${query}' not found`);
            const { coordinates } = data.features[0].geometry; return { lat: coordinates[1], lng: coordinates[0] };
        }
        function showMessage(text, type) { const msgDiv = document.getElementById('message'); msgDiv.textContent = text; msgDiv.className = `message ${type}`; if (type !== 'win') { setTimeout(() => { msgDiv.textContent = ''; msgDiv.className = ''; }, 3000); } }
        function updatePath() { if (pathLine) map.removeLayer(pathLine); if (gameState.visitedBars.length > 0) { const points = [ [gameState.startingPoint.lat, gameState.startingPoint.lng], ...gameState.visitedBars.map(bar => [bar.lat, bar.lng]) ]; pathLine = L.polyline(points, { color: '#667eea', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(map); } }

        async function initGame() {
            if (map) map.remove();
            map = L.map('map').setView([47.3769, 8.5417], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors', maxZoom: 19 }).addTo(map);
            
            markers.forEach(marker => marker.remove()); markers = [];
            if (pathLine) pathLine.remove();
            eliminationZones.forEach(zone => zone.remove()); eliminationZones = [];
            clearPreview();

            const targetBarName = zurichBars[Math.floor(Math.random() * zurichBars.length)];
            const targetLoc = await geocodeLocation(targetBarName);
            
            gameArea = L.rectangle([[GAME_BOUNDS.south, GAME_BOUNDS.west], [GAME_BOUNDS.north, GAME_BOUNDS.east]], { color: '#667eea', weight: 2, fillOpacity: 0.1, dashArray: '5, 5' }).addTo(map);
            gameArea.bindPopup('Game Area - Find bars within this zone!');

            gameState.targetBar = targetBarName; gameState.targetLocation = targetLoc;
            gameState.visitedBars = []; gameState.visitCount = 0; gameState.gameWon = false;

            const startMarker = L.marker([gameState.startingPoint.lat, gameState.startingPoint.lng], { icon: startIcon }).addTo(map);
            startMarker.bindPopup(`<div class="bar-popup"><h3>üèÅ Starting Point</h3><p>${gameState.startingPoint.name}</p></div>`);
            markers.push(startMarker);

            document.getElementById('targetBar').textContent = '???';
            document.getElementById('visitCount').textContent = '0';
            document.getElementById('startingBar').textContent = gameState.startingPoint.name;
            barInput.disabled = false; previewBtn.disabled = false;
            showMessage('New game started! Find the hidden bar.', 'success');
            map.fitBounds(gameArea.getBounds(), { padding: [10, 10] });
        }

        async function tryBar() {
            if (gameState.gameWon || !previewedLocation) return;
            const query = barInput.value.trim();
            const location = previewedLocation;
            clearPreview();
            
            const prevLocation = gameState.visitedBars.length > 0 ? gameState.visitedBars[gameState.visitedBars.length - 1] : gameState.startingPoint;
            const currentDist = distance(location, gameState.targetLocation);
            const prevDist = distance(prevLocation, gameState.targetLocation);
            const isWarmer = currentDist < prevDist;
            
            gameState.visitCount++;
            gameState.visitedBars.push({ name: query, ...location });

            const isWin = query.toLowerCase().includes(gameState.targetBar.toLowerCase());
            const icon = isWin ? winIcon : visitedIcon(gameState.visitCount, isWarmer);
            
            const marker = L.marker([location.lat, location.lng], { icon }).addTo(map)
                .bindPopup(`<div class="bar-popup"><h3>${isWin ? 'üéâ ' : (isWarmer ? 'üî• ' : '‚ùÑÔ∏è ')}${query}</h3><p><span class="visit-number">${gameState.visitCount}</span> Visit #${gameState.visitCount}</p>${!isWin ? `<p style="font-weight: 600; color: ${isWarmer ? '#FF6347' : '#4169E1'}">${isWarmer ? 'üî• Warmer!' : '‚ùÑÔ∏è Colder!'}</p>` : ''}${isWin ? '<p style="color: #4CAF50; font-weight: 600;">YOU FOUND IT!</p>' : ''}</div>`)
                .openPopup();
            markers.push(marker);
            
            createEliminationZone(prevLocation, location, isWarmer);
            updatePath();
            map.flyTo([location.lat, location.lng], map.getZoom() + 1, { duration: 1 });
            document.getElementById('visitCount').textContent = gameState.visitCount;

            if (isWin) {
                gameState.gameWon = true;
                document.getElementById('targetBar').textContent = gameState.targetBar;
                showMessage(`üéâ Congratulations! You found ${gameState.targetBar} in ${gameState.visitCount} tries!`, 'win');
                barInput.disabled = true; previewBtn.disabled = true;
            } else { showMessage(isWarmer ? 'üî• Getting warmer!' : '‚ùÑÔ∏è Getting colder!', isWarmer ? 'warmer' : 'colder'); }
        }

        function setButtonsToPreviewState(isPreviewing) {
            previewBtn.classList.toggle('hidden', isPreviewing);
            confirmBtn.classList.toggle('hidden', !isPreviewing);
            cancelBtn.classList.toggle('hidden', !isPreviewing);
            barInput.disabled = isPreviewing;
        }

        async function previewBar() {
            const query = barInput.value.trim();
            if (!query) { showMessage('Please enter a bar name to preview.', 'error'); return; }
            clearPreview();
            
            try {
                const location = await geocodeLocation(query);
                if (location.lat < GAME_BOUNDS.south || location.lat > GAME_BOUNDS.north || location.lng < GAME_BOUNDS.west || location.lng > GAME_BOUNDS.east) {
                    showMessage(`'${query}' is outside the game area.`, 'error'); return;
                }
                previewedLocation = location;

                const prevLocation = gameState.visitedBars.length > 0 ? gameState.visitedBars[gameState.visitedBars.length - 1] : gameState.startingPoint;
                const prev_xy = { x: prevLocation.lng, y: prevLocation.lat };
                const current_xy = { x: location.lng, y: location.lat };
                const linePoints = getBisectorLinePoints(prev_xy, current_xy);

                if (linePoints.length >= 2) {
                    previewLine = L.polyline(linePoints, { color: '#f97316', weight: 4, opacity: 0.8, dashArray: '8, 8' }).addTo(map);
                    setButtonsToPreviewState(true);
                }
            } catch (error) { showMessage(error.message, 'error'); }
        }

        function clearPreview() {
            if (previewLine) map.removeLayer(previewLine);
            previewLine = null;
            previewedLocation = null;
            setButtonsToPreviewState(false);
            barInput.value = '';
            if (!gameState.gameWon) barInput.disabled = false;
        }

        // --- EVENT LISTENERS ---
        startGameBtn.addEventListener('click', async () => {
            const setupError = document.getElementById('setupError');
            setupError.textContent = '';
            startGameBtn.disabled = true;
            startGameBtn.textContent = 'Loading...';
            try {
                const startLocName = document.getElementById('startLocationInput').value;
                const startLocCoords = await geocodeLocation(startLocName);
                gameState.startingPoint = { name: startLocName, ...startLocCoords };

                GAME_BOUNDS.north = parseFloat(document.getElementById('northBoundInput').value);
                GAME_BOUNDS.south = parseFloat(document.getElementById('southBoundInput').value);
                GAME_BOUNDS.east = parseFloat(document.getElementById('eastBoundInput').value);
                GAME_BOUNDS.west = parseFloat(document.getElementById('westBoundInput').value);

                setupScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
                await initGame();
            } catch (error) {
                setupError.textContent = `Error: ${error.message}. Please try another location.`;
            } finally {
                startGameBtn.disabled = false;
                startGameBtn.textContent = 'Start Game';
            }
        });

        previewBtn.addEventListener('click', previewBar);
        confirmBtn.addEventListener('click', tryBar);
        cancelBtn.addEventListener('click', clearPreview);
        resetBtn.addEventListener('click', () => {
            gameScreen.classList.add('hidden');
            setupScreen.classList.remove('hidden');
        });
        barInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') previewBtn.click(); });
    </script>
</body>
</html>

